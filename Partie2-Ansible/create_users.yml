---
# ===============================================================================
#
#          FILE:  create_users.yml
#
#   DESCRIPTION:  Playbook Ansible pour l'automatisation de crÃ©ation d'utilisateurs
#                 Charge les utilisateurs depuis le fichier users.txt
#                 TP 1 - INF 3611 : Administration SystÃ¨mes et RÃ©seaux
#
#        AUTHOR:  AZAB A RANGA FRANCK MIGUEL
#     MATRICULE:  23V2227
#       FILIÃˆRE:  Informatique L3
#   INSTITUTION:  UniversitÃ© de YaoundÃ© I - FacultÃ© des Sciences
#
#       VERSION:  1.0
#       CREATED:  01/12/2025
#
# ===============================================================================

- name: Automatisation de la crÃ©ation d'utilisateurs sous Linux
  hosts: vps_servers
  become: yes
  gather_facts: yes

  vars:
    # Nom du groupe Ã  crÃ©er
    group_name: "students-inf-361"
    
    # Quota disque en Go
    disk_quota_gb: 15
    
    # Limite mÃ©moire en pourcentage de RAM
    ram_limit_percent: 20
    
    # Configuration du serveur SSH (port modifiÃ© pour la sÃ©curitÃ© - voir Partie0)
    ssh_port: 2222
    
    # Fichier source des utilisateurs (format TXT)
    users_file: "{{ playbook_dir }}/users.txt"
    
    # Configuration email - Les secrets sont dans vault.yml
    smtp_host: "{{ smtp_host | default('smtp.gmail.com') }}"
    smtp_port: "{{ smtp_port | default(587) }}"
    smtp_user: "{{ smtp_user | default('francnkkaezer30@gmail.com') }}"
    # smtp_password est chargÃ© depuis vault.yml
    email_from: "admin@univ-yaounde1.cm"

  # Charger les secrets depuis le fichier vault
  vars_files:
    - vault.yml

  tasks:
    # =========================================================================
    # CHARGEMENT DES UTILISATEURS DEPUIS LE FICHIER users.txt
    # =========================================================================
    
    - name: Lecture du fichier users.txt
      slurp:
        src: "{{ users_file }}"
      register: users_file_content
      delegate_to: localhost
      become: no
    
    - name: Parsing du fichier users.txt
      set_fact:
        users: >-
          {{
            (users_file_content.content | b64decode).split('\n')
            | select('match', '^[^#].*')
            | select('search', ';')
            | map('regex_replace', '^([^;]+);([^;]+);([^;]+);([^;]+);([^;]+);([^;]+)\\s*$', '{"username": "\1", "password": "\2", "full_name": "\3", "phone": "\4", "email": "\5", "shell": "\6"}')
            | map('from_json')
            | list
          }}
    
    - name: Affichage des utilisateurs chargÃ©s
      debug:
        msg: "{{ users | length }} utilisateur(s) chargÃ©(s) depuis {{ users_file }}"
    
    # =========================================================================
    # PRÃ‰PARATION DU SYSTÃˆME
    # =========================================================================
    
    - name: Mise Ã  jour du cache des paquets
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
    
    - name: Installation des paquets requis (Debian/Ubuntu)
      apt:
        name:
          - quota
          - libpam-modules
          - mailutils
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"
    
    # =========================================================================
    # CRÃ‰ATION DU GROUPE
    # =========================================================================
    
    - name: CrÃ©ation du groupe {{ group_name }}
      group:
        name: "{{ group_name }}"
        state: present
      register: group_created
    
    - name: Log - Groupe crÃ©Ã©
      debug:
        msg: "Groupe '{{ group_name }}' crÃ©Ã© avec succÃ¨s"
      when: group_created.changed
    
    # =========================================================================
    # CONFIGURATION DE LA RESTRICTION 'su'
    # =========================================================================
    
    - name: CrÃ©ation du groupe wheel
      group:
        name: wheel
        state: present
    
    - name: Ajout de root au groupe wheel
      user:
        name: root
        groups: wheel
        append: yes
    
    - name: Sauvegarde du fichier PAM su
      copy:
        src: /etc/pam.d/su
        dest: /etc/pam.d/su.backup
        remote_src: yes
        force: no
    
    - name: Activation de la restriction su via PAM
      lineinfile:
        path: /etc/pam.d/su
        regexp: '^#?\s*auth\s+required\s+pam_wheel\.so'
        line: 'auth       required   pam_wheel.so'
        state: present
    
    # =========================================================================
    # CRÃ‰ATION DES UTILISATEURS
    # =========================================================================
    
    - name: VÃ©rification et installation des shells requis
      block:
        - name: Obtenir la liste des shells uniques demandÃ©s
          set_fact:
            required_shells: "{{ users | map(attribute='shell') | unique | list }}"
        
        - name: Installer zsh si nÃ©cessaire
          apt:
            name: zsh
            state: present
          when: 
            - ansible_os_family == "Debian"
            - "'/bin/zsh' in required_shells or '/usr/bin/zsh' in required_shells"
        
        - name: Installer fish si nÃ©cessaire
          apt:
            name: fish
            state: present
          when: 
            - ansible_os_family == "Debian"
            - "'/usr/bin/fish' in required_shells"
    
    - name: CrÃ©ation des utilisateurs
      user:
        name: "{{ item.username }}"
        comment: "{{ item.full_name }},{{ item.phone }},{{ item.email }}"
        shell: "{{ item.shell if item.shell | regex_search('^/') else '/bin/bash' }}"
        groups: 
          - "{{ group_name }}"
          - sudo
        append: yes
        create_home: yes
        password: "{{ item.password | password_hash('sha512') }}"
        state: present
      loop: "{{ users }}"
      register: users_created
    
    - name: Forcer le changement de mot de passe Ã  la premiÃ¨re connexion
      command: chage -d 0 {{ item.username }}
      loop: "{{ users }}"
      changed_when: true
    
    # =========================================================================
    # MESSAGE DE BIENVENUE
    # =========================================================================
    
    - name: CrÃ©ation du fichier WELCOME.txt
      template:
        src: templates/welcome.txt.j2
        dest: "/home/{{ item.username }}/WELCOME.txt"
        owner: "{{ item.username }}"
        group: "{{ item.username }}"
        mode: '0644'
      loop: "{{ users }}"
    
    - name: Ajout de l'affichage du message dans .bashrc
      blockinfile:
        path: "/home/{{ item.username }}/.bashrc"
        block: |
          # Affichage du message de bienvenue - INF 3611
          if [ -f ~/WELCOME.txt ]; then
              cat ~/WELCOME.txt
          fi
        marker: "# {mark} ANSIBLE MANAGED BLOCK - WELCOME MESSAGE"
        create: yes
        owner: "{{ item.username }}"
        group: "{{ item.username }}"
      loop: "{{ users }}"
    
    # =========================================================================
    # CONFIGURATION DES QUOTAS DISQUE
    # =========================================================================
    
    - name: Configuration des limites mÃ©moire dans limits.conf
      blockinfile:
        path: /etc/security/limits.conf
        block: |
          # Limites pour l'utilisateur {{ item.username }} - INF 3611
          {{ item.username }}     soft    as      {{ (ansible_memtotal_mb * 1024 * ram_limit_percent / 100) | int }}
          {{ item.username }}     hard    as      {{ (ansible_memtotal_mb * 1024 * ram_limit_percent / 100) | int }}
          {{ item.username }}     soft    nproc   100
          {{ item.username }}     hard    nproc   150
        marker: "# {mark} ANSIBLE MANAGED BLOCK - {{ item.username }}"
      loop: "{{ users }}"
    
    # =========================================================================
    # ENVOI D'EMAIL DE BIENVENUE
    # =========================================================================
    
    - name: Obtenir l'adresse IP du serveur
      set_fact:
        server_ip: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
    
    - name: Envoi de l'email de bienvenue Ã  chaque utilisateur
      mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user }}"
        password: "{{ smtp_password }}"
        from: "{{ email_from }}"
        to: "{{ item.email }}"
        subject: "Bienvenue sur le serveur VPS - INF 3611"
        body: |
          Bonjour {{ item.full_name }},

          Bienvenue sur le serveur VPS du cours INF 3611 - Administration SystÃ¨mes et RÃ©seaux !

          Votre compte utilisateur a Ã©tÃ© crÃ©Ã© avec succÃ¨s. Voici vos informations de connexion :

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            INFORMATIONS DE CONNEXION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“ Adresse IP du serveur : {{ server_ip }}
          ğŸ”Œ Port SSH              : {{ ssh_port }}
          ğŸ‘¤ Nom d'utilisateur     : {{ item.username }}
          ğŸ”‘ Mot de passe initial  : {{ item.password }}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            COMMANDES DE CONNEXION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ’» Commande SSH pour se connecter :
             ssh {{ item.username }}@{{ server_ip }} -p {{ ssh_port }}

          ğŸ” Commande pour transmettre votre clÃ© publique SSH :

             â€¢ Linux/macOS :
               ssh-copy-id -p {{ ssh_port }} {{ item.username }}@{{ server_ip }}

             â€¢ Windows (PowerShell) :
               type $env:USERPROFILE\.ssh\id_rsa.pub | ssh -p {{ ssh_port }} {{ item.username }}@{{ server_ip }} "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

             â€¢ Alternative universelle :
               cat ~/.ssh/id_rsa.pub | ssh -p {{ ssh_port }} {{ item.username }}@{{ server_ip }} "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            INFORMATIONS IMPORTANTES
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          âš ï¸  Vous devrez changer votre mot de passe lors de votre premiÃ¨re connexion.
          ğŸ“Š Votre quota d'espace disque est de {{ disk_quota_gb }} Go.
          ğŸ§  Limite mÃ©moire par processus : {{ ram_limit_percent }}% de la RAM.

          Si vous avez des questions, n'hÃ©sitez pas Ã  contacter l'administrateur systÃ¨me.

          Cordialement,
          L'Ã©quipe d'administration systÃ¨me
          INF 3611 - UniversitÃ© de YaoundÃ© I
        subtype: plain
      loop: "{{ users }}"
      ignore_errors: yes
      register: email_result
    
    - name: Avertissement si l'envoi d'email Ã©choue
      debug:
        msg: "âš ï¸ L'envoi d'email Ã  {{ item.item.email }} a Ã©chouÃ©. VÃ©rifiez la configuration SMTP."
      loop: "{{ email_result.results }}"
      when: item.failed | default(false)
    
    # =========================================================================
    # GÃ‰NÃ‰RATION DU LOG
    # =========================================================================
    
    - name: CrÃ©ation du fichier de log
      copy:
        content: |
          ================================================================================
          RAPPORT DE CRÃ‰ATION D'UTILISATEURS - ANSIBLE
          ================================================================================
          Date d'exÃ©cution    : {{ ansible_date_time.iso8601 }}
          Serveur cible       : {{ inventory_hostname }} ({{ server_ip }})
          Groupe crÃ©Ã©         : {{ group_name }}
          Fichier source      : {{ users_file }}
          ================================================================================
          
          UTILISATEURS CRÃ‰Ã‰S :
          {% for user in users %}
          - {{ user.username }} ({{ user.full_name }}) - {{ user.email }}
          {% endfor %}
          
          CONFIGURATION APPLIQUÃ‰E :
          - Quota disque      : {{ disk_quota_gb }} Go
          - Limite mÃ©moire    : {{ ram_limit_percent }}% RAM
          - Changement MDP    : Obligatoire Ã  la premiÃ¨re connexion
          - Groupe sudo       : Oui
          - Restriction su    : ActivÃ©e (groupe wheel)
          
          ================================================================================
          Auteur: AZAB A RANGA FRANCK MIGUEL - 23V2227
          INF 3611 - UniversitÃ© de YaoundÃ© I
          ================================================================================
        dest: "/var/log/ansible_user_creation_{{ ansible_date_time.date }}.log"
        mode: '0644'
    
    # =========================================================================
    # RÃ‰SUMÃ‰ FINAL
    # =========================================================================
    
    - name: Affichage du rÃ©sumÃ©
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… CRÃ‰ATION DES UTILISATEURS TERMINÃ‰E AVEC SUCCÃˆS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š RÃ©sumÃ© :
             - Groupe crÃ©Ã©          : {{ group_name }}
             - Utilisateurs crÃ©Ã©s   : {{ users | length }}
             - Fichier source       : {{ users_file }}
             - Emails envoyÃ©s       : {{ users | length }}
          
          ğŸ“ Fichiers gÃ©nÃ©rÃ©s :
             - Log: /var/log/ansible_user_creation_{{ ansible_date_time.date }}.log
             - WELCOME.txt dans chaque rÃ©pertoire utilisateur
          
          ğŸ” SÃ©curitÃ© :
             - Mot de passe hachÃ© SHA-512
             - Changement obligatoire Ã  la premiÃ¨re connexion
             - Restriction 'su' activÃ©e
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
